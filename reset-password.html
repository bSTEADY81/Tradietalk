
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password â€“ TradieTalk AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-blue-50 flex items-center justify-center">
    <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
      <h1 class="text-2xl font-bold text-center mb-6">Reset Your Password</h1>
      <p class="text-sm text-gray-600 mb-6 text-center">Enter your new password below.</p>
      
      <form id="resetPasswordForm" class="space-y-4">
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
          <input id="newPassword" type="password" required minlength="6" class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <p class="text-xs text-gray-500 mt-1">Password must be at least 6 characters long.</p>
        </div>
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
          <input id="confirmPassword" type="password" required minlength="6" class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <p id="resetError" class="hidden text-sm text-red-600"></p>
        <p id="resetSuccess" class="hidden text-sm text-green-600"></p>
        <button type="submit" id="updatePasswordBtn" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Update Password</button>
      </form>
      
      <p class="mt-4 text-sm text-center">
        <a href="login.html" class="text-blue-600 hover:underline">Back to Sign In</a>
      </p>
    </div>

    <!-- Load Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.umd.min.js"></script>
    <script src="script.js"></script>
    <script>
      // Extract tokens from URL hash
      let accessToken = null;
      let refreshToken = null;
      
      function extractTokensFromURL() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        accessToken = params.get('access_token');
        refreshToken = params.get('refresh_token');
        
        if (!accessToken || !refreshToken) {
          document.getElementById('resetError').textContent = 'Invalid or expired reset link. Please request a new password reset.';
          document.getElementById('resetError').classList.remove('hidden');
          document.getElementById('updatePasswordBtn').disabled = true;
          return false;
        }
        return true;
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        if (!extractTokensFromURL()) {
          return;
        }

        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const resetError = document.getElementById('resetError');
        const resetSuccess = document.getElementById('resetSuccess');
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');

        resetPasswordForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;
          
          // Hide previous messages
          resetError.classList.add('hidden');
          resetSuccess.classList.add('hidden');
          
          // Validate passwords
          if (newPassword.length < 6) {
            resetError.textContent = 'Password must be at least 6 characters long.';
            resetError.classList.remove('hidden');
            return;
          }
          
          if (newPassword !== confirmPassword) {
            resetError.textContent = 'Passwords do not match.';
            resetError.classList.remove('hidden');
            return;
          }
          
          // Disable button and show loading state
          updatePasswordBtn.disabled = true;
          updatePasswordBtn.textContent = 'Updating...';
          
          if (supabase) {
            try {
              // Set the session using the tokens from the URL
              const { error: sessionError } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
              });
              
              if (sessionError) {
                resetError.textContent = 'Invalid or expired reset link. Please request a new password reset.';
                resetError.classList.remove('hidden');
                updatePasswordBtn.disabled = false;
                updatePasswordBtn.textContent = 'Update Password';
                return;
              }
              
              // Update the user's password
              const { error: updateError } = await supabase.auth.updateUser({
                password: newPassword
              });
              
              if (updateError) {
                resetError.textContent = updateError.message;
                resetError.classList.remove('hidden');
                updatePasswordBtn.disabled = false;
                updatePasswordBtn.textContent = 'Update Password';
                return;
              }
              
              // Success
              resetSuccess.textContent = 'Password updated successfully! Redirecting to sign in...';
              resetSuccess.classList.remove('hidden');
              updatePasswordBtn.textContent = 'Password Updated';
              
              // Redirect to login page after 2 seconds
              setTimeout(() => {
                window.location.href = 'login.html';
              }, 2000);
              
            } catch (err) {
              resetError.textContent = 'An unexpected error occurred. Please try again.';
              resetError.classList.remove('hidden');
              updatePasswordBtn.disabled = false;
              updatePasswordBtn.textContent = 'Update Password';
              console.error('Password update error:', err);
            }
          } else {
            resetError.textContent = 'Password reset is not available. Please contact support.';
            resetError.classList.remove('hidden');
            updatePasswordBtn.disabled = false;
            updatePasswordBtn.textContent = 'Update Password';
          }
        });
      });
    </script>
  </body>
</html>
